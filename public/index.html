<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bass Note Master - Pro</title>
  <script src="https://js.stripe.com/v3/"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#0D1117; --glow1:#22D3EE; --glow2:#A78BFA; --accent:#0EA5E9; --text:#E5E7EB; --muted:#9CA3AF; --border:rgba(255,255,255,0.1);}  
    body{ font-family:"Inter",system-ui,Arial,Helvetica,sans-serif; background:radial-gradient(80vw 80vw at 10% 0%, rgba(34,211,238,.08), transparent 60%), radial-gradient(80vw 80vw at 90% 0%, rgba(167,139,250,.08), transparent 60%), linear-gradient(to bottom right,#0b0f14,#0D1117); color:var(--text);} 
    .pane{ background:rgba(17,24,39,.6); border:1px solid var(--border); border-radius:1rem; backdrop-filter:blur(18px); box-shadow:0 20px 60px rgba(0,0,0,.45);}  
    .fret{ stroke:#6B7280; stroke-width:1.5px; } .string{ stroke:#4B5563; stroke-width:2px; } .inlay{ fill:#4B5563; }
    .n{ cursor:pointer; transition:opacity .15s ease, transform .1s ease, fill .2s ease, stroke .2s ease; }
    .n-root{ fill:var(--glow2); stroke:#C4B5FD; stroke-width:2.25px; }
    .n-root-ring{ fill:transparent; stroke:rgba(167,139,250,.55); stroke-width:3px; opacity:.6; }
    .n-scale{ fill:var(--glow1); stroke:#67E8F9; stroke-width:1.5px; }
    .n-open{ fill:#4B5563; stroke:#374151; stroke-width:1px; }
    .n-hide{ fill:transparent; stroke:none; } .n-ok{ fill:#10B981 !important; } .n-bad{ fill:#F43F5E !important; } .n-hint{ fill:transparent; stroke:#67E8F9; stroke-width:1.5px; opacity:.95; }
    .nt{ font-size:11px; font-weight:700; pointer-events:none; text-shadow:0 0 4px rgba(0,0,0,.7);} .nt-on{ fill:#000;} .nt-off{ fill:#9CA3AF;}
    @media (max-width:480px){ .nt{ font-size:12px; } }
    .fret-num{ font-size:12px; fill:#9CA3AF; text-anchor:middle; dominant-baseline:hanging; }
    .chip{ display:inline-flex; align-items:center; padding:.25rem .5rem; border:1px solid var(--border); border-radius:.5rem; background:rgba(17,24,39,.5); margin:.15rem; font-weight:700; font-size:.85rem; }
    .chip-mode{ background:rgba(34,211,238,.2); border-color:rgba(103,232,249,.4); }
    .chip-parent{ outline:2px solid #a78bfa88; }
    @keyframes hitPulse{0%{transform:scale(1)}50%{transform:scale(1.2)}100%{transform:scale(1)}}
    .hit-pulse{ animation: hitPulse .18s ease-in-out; }
    @keyframes missShake{0%{transform:translateX(0)}25%{transform:translateX(-3px)}50%{transform:translateX(3px)}75%{transform:translateX(-2px)}100%{transform:translateX(0)}}
    .miss-shake{ animation: missShake .2s ease-in-out; }
    @keyframes confettiFall{0%{opacity:1; transform:translateY(-20px) rotate(0)}100%{opacity:0; transform:translateY(220px) rotate(720deg)}}
    .confetti-piece{ position:fixed; top:0; width:6px; height:10px; border-radius:2px; z-index:50; pointer-events:none; animation: confettiFall 1.4s ease-out forwards; }
    .bar{ height:6px; border-radius:9999px; transition:transform .15s ease; }
    .bar.bg{ background:#374151; } .bar.fg{ background:#38BDF8; }
    .bar-pulse{ animation: hitPulse .22s ease-in-out; }
    .spinner{ width:14px; height:14px; border:2px solid rgba(255,255,255,.35); border-top-color:rgba(255,255,255,1); border-radius:50%; animation:spin .8s linear infinite; display:inline-block; vertical-align:-2px; margin-right:.4rem; }
    @keyframes spin{ to{ transform: rotate(360deg); } }
  </style>
</head>
<body class="min-h-screen p-5 md:p-8">
  <div class="max-w-7xl mx-auto">
    <header class="flex flex-col items-center gap-4 mb-8">
      <!-- Logo added here -->
      <img src="https://kajabi-storefronts-production.kajabi-cdn.com/kajabi-storefronts-production/file-uploads/themes/2162277835/settings_images/3b31360-24e8-a511-851f-cfaccbafe88f_BNM_logo.png" alt="Bass Note Master Logo" class="w-24 h-auto mb-2">
      <h1 class="text-4xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-sky-400 to-cyan-300">Bass Note Master</h1>
      <nav class="pane px-2 py-1 w-full">
        <div class="flex items-center justify-center gap-2">
          <div class="flex gap-1">
            <button id="nav-fret" class="px-4 py-2 rounded-md text-sm font-semibold bg-sky-600 text-white focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sky-400/60 focus-visible:ring-offset-1 focus-visible:ring-offset-slate-900">Fretboard</button>
            <button id="nav-lessons" class="px-4 py-2 rounded-md text-sm font-semibold text-gray-200 hover:bg-white/10 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sky-400/60 focus-visible:ring-offset-1 focus-visible:ring-offset-slate-900">Unlock Lessons</button>
            <button id="nav-game" class="px-4 py-2 rounded-md text-sm font-semibold text-gray-200 hover:bg-white/10 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sky-400/60 focus-visible:ring-offset-1 focus-visible:ring-offset-slate-900">Game</button>
          </div>
        </div>
      </nav>
    </header>

    <main id="app" class="space-y-6"></main>
    <footer class="mt-8">
      <div class="pane px-4 py-3 text-center text-[0.8rem] text-gray-300">
        Â© 2025 Groove School | Ted Talks Bass LLC | YouTube @TedTalksBass | Version 1.2
      </div>
    </footer>
  </div>

<script>
window.addEventListener('DOMContentLoaded', async () => {
  // Initialize Stripe.js with your publishable key
  const stripe = Stripe('pk_test_5FGiRp8oYllXy7shpXf1FeMA');

  // Define your backend's absolute API URL here.
  // This is crucial for the frontend to correctly address your deployed backend.
  const BASE_API_URL = "https://bassnotemaster.onrender.com"; // CONFIGURED BY USER

  // Helper to construct URLs for backend calls
  function getBackendUrl(path) {
    if (!BASE_API_URL || BASE_API_URL === "YOUR_RENDER_BACKEND_URL_HERE") {
      console.error("BASE_API_URL is not configured. Please set it to your deployed Render backend URL.");
      return path; // Fallback to relative path, which will likely fail
    }
    return `${BASE_API_URL}${path}`;
  }

  // A simple way to get a consistent user ID for anonymous users (without explicit login)
  // In a real app, this would be tied to user authentication/session management.
  function getOrCreateAnonymousUserId() {
    let userId = localStorage.getItem('bassTrainerUserId');
    if (!userId) {
      userId = 'anon_' + Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
      localStorage.setItem('bassTrainerUserId', userId);
    }
    return userId;
  }
  const currentUserId = getOrCreateAnonymousUserId(); // Get or create user ID

  // ---- STATE ----
  const state = {
    isPro: false, // Will be set by backend
    isProStatusLoaded: false, // Flag to indicate if Pro status has been fetched
    isLeftHanded: localStorage.getItem('bassTrainerLeftHanded') === 'true',
    view:'fret',
    musical:{ root:'C', mode:'ionian', kind:'scale', chordType:'majorTriad', strings:'4' },
    lessonIndex:0,
    game:{ on:false, over:false, target:null, found:[], total:0, t0:null, t1:null, timer:null, combo:0, misses:0, msg:'', lastHintAt:null, difficulty:'standard', focusPair:'E&A', justFound:0, hintsUsed:0, score:0, highScore:0 }
  };

  // Load high score from local storage (this remains local for now)
  state.game.highScore = parseInt(localStorage.getItem('bassTrainerHighScore') || '0', 10);

  // --- Function to fetch Pro status from backend ---
  async function fetchProStatusFromBackend() {
    console.log("Current window.location.href:", window.location.href);
    console.log("Current window.location.origin:", window.location.origin);
    const requestUrl = getBackendUrl('/user-status');
    console.log("Attempting to fetch Pro status from:", requestUrl);

    // If BASE_API_URL is not configured, getBackendUrl will return a relative path
    // and log an error. If it's still "YOUR_RENDER_BACKEND_URL_HERE", the fetch will fail.
    if (requestUrl === '/user-status' && BASE_API_URL === "YOUR_RENDER_BACKEND_URL_HERE") {
        state.isProStatusLoaded = true; // Mark as loaded to stop spinner, but without Pro access
        renderApp();
        return; // Exit early if URL is not configured
    }


    try {
      // Pass user ID in headers for backend to identify the user
      const response = await fetch(requestUrl, {
        headers: {
          'X-User-Id': currentUserId // Send user ID to backend
        }
      }); 
      if (response.ok) {
        const data = await response.json();
        state.isPro = data.isPro === true;
        console.log("Pro status loaded from backend:", state.isPro);
      } else {
        // Log the full response text for more debugging info
        const errorText = await response.text();
        console.error(`Failed to fetch Pro status from backend (HTTP ${response.status}):`, response.statusText, errorText);
        state.isPro = false; // Default to non-pro on error
      }
    } catch (error) {
      console.error("Network error fetching Pro status:", error);
      state.isPro = false; // Default to non-pro on network error
    } finally {
      state.isProStatusLoaded = true; // Mark Pro status as loaded
      renderApp(); // Render the app after Pro status is loaded
    }
  }

  // ---- THEORY & DATA ----
  const scalesMaj = { 'C':['C','D','E','F','G','A','B'],'G':['G','A','B','C','D','E','F#'],'D':['D','E','F#','G','A','B','C#'],'A':['A','B','C#','D','E','F#','G#'],'E':['E','F#','G#','A','B','C#','D#'],'B':['B','C#','D#','E','F#','G#','A#'],'F#':['F#','G#','A#','B','C#','D#','E#'],'C#':['C#','D#','E#','F#','G#','A#','B#'],'F':['F','G','A','Bb','C','D','E'],'Bb':['Bb','C','D','Eb','F','G','A'],'Eb':['Eb','F','G','Ab','Bb','C','D'],'Ab':['Ab','Bb','C','Db','Eb','F','G'],'Db':['Db','Eb','F','Gb','Ab','Bb','C'],'Gb':['Gb','Ab','Bb','Cb','Db','Eb','F'],'Cb':['Cb','Db','Eb','Fb','Gb','Ab','Bb'] };
  const allRoots = Object.keys(scalesMaj).sort();
  const freeRoots = ['C', 'G', 'D', 'A'];
  const allChordTypes = ['majorTriad','major7th','minorTriad','minor7th','dominant7th','diminishedTriad','halfDiminished7th','diminished7th','augmentedTriad'];
  const freeChordTypes = ['majorTriad', 'minorTriad'];
  const chromSharp = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
  const enhNorm = n => ({'Db':'C#','Eb':'D#','Gb':'F#','Ab':'G#','Bb':'A#','Cb':'B','Fb':'E','E#':'F','B#':'C'}[n]||n);
  const flat = n => ({'C':'Cb','D':'Db','E':'Eb','F':'Fb','G':'Gb','A':'Ab','B':'Bb','C#':'C','D#':'D','E#':'E','F#':'F','G#':'G','A#':'A','B#':'B'}[n]||n);
  const sharp = n => ({'C':'C#','D':'D#','E':'E#','F':'F#','G':'G#','A':'A#','B':'B#','Cb':'C','Db':'D','Eb':'E','Fb':'F','Gb':'G','Ab':'A','Bb':'B'}[n||n]);
  const modeOffset = { ionian:0, dorian:2, phrygian:4, lydian:5, mixolydian:7, aeolian:9, locrian:11 };
  // Define modes available for free users
  const freeModes = ['ionian', 'aeolian'];

  const parentMajor = (modeRoot, modeName) => { const semi = modeOffset[modeName]; const idx = chromSharp.indexOf(enhNorm(modeRoot)); if (semi===undefined || idx===-1) return null; const pPitch = chromSharp[(idx - semi + 12) % 12]; const opts = Object.keys(scalesMaj).filter(k => enhNorm(k)===pPitch); const match = opts.find(k => scalesMaj[k].some(n => enhNorm(n)===enhNorm(modeRoot))); return match || opts[0] || null; };
  const notesForMode = (modeRoot, modeName) => { const parent = parentMajor(modeRoot, modeName); if (!parent) return []; const scale = scalesMaj[parent]; let start = scale.findIndex(n => enhNorm(n)===enhNorm(modeRoot)); if (start<0) start = 0; return [...scale.slice(start), ...scale.slice(0,start)]; };
  const chordNotes = (root, type) => { const norm = enhNorm(root); const key = Object.keys(scalesMaj).find(k=>enhNorm(k)===norm); if (!key) return []; const scale = scalesMaj[key]; const rIdx = scale.findIndex(n=>enhNorm(n)===norm); if (rIdx<0) return []; const re = [...scale.slice(rIdx), ...scale.slice(0,rIdx)]; const tones=[scale[rIdx]]; switch(type){ case 'majorTriad': tones.push(re[2],re[4]); break; case 'major7th': tones.push(re[2],re[4],re[6]); break; case 'minorTriad': tones.push(flat(re[2]),re[4]); break; case 'minor7th': tones.push(flat(re[2]),re[4],flat(re[6])); break; case 'dominant7th': tones.push(re[2],re[4],flat(re[6])); break; case 'diminishedTriad': tones.push(flat(re[2]),flat(re[4])); break; case 'halfDiminished7th': tones.push(flat(re[2]),flat(re[4]),flat(re[6])); break; case 'diminished7th': tones.push(flat(re[2]),flat(re[4]),flat(flat(re[6]))); break; case 'augmentedTriad': tones.push(re[2],sharp(re[4])); break; default: tones.push(re[2],re[4]); } return tones; };
  const idxFromOpen = (open,fret) => (chromSharp.indexOf(enhNorm(open)) + fret) % 12;
  const getTuning = (strings) => ({ '4':['E','A','D','G'], '5':['B','E','A','D','G'], '6':['B','E','A','D','G','C'] })[strings];
  const focusPairsForTuning = (tuning) => { const pairs=[]; for(let i=0;i<tuning.length-1;i++){ const a=tuning[i], b=tuning[i+1]; pairs.push({ key:`${a}&${b}`, label:`${a} & ${b}` }); } return pairs; };
  const ensureFocusPairValid = () => { const pairs = focusPairsForTuning(getTuning(state.musical.strings)).map(p=>p.key); if (!pairs.includes(state.game.focusPair)) state.game.focusPair = pairs[0] || 'E&A'; };

  // ---- RENDERERS ----
  const app = document.getElementById('app');

  // Main render function, now conditional on Pro status loading from backend
  function renderApp(){
    // Show loading spinner until Pro status is confirmed by backend
    if (!state.isProStatusLoaded) {
      app.innerHTML = `
        <div class="flex items-center justify-center min-h-[50vh]">
          <div class="spinner w-8 h-8 !m-0 !mr-0"></div>
          <p class="text-lg text-gray-300 ml-3">Loading app...</p>
        </div>
      `;
      return;
    }
    render(); // Call the original render function once ready
    updateNav(); // Ensure nav is updated based on final state
    setActive(state.view); // Set active nav button
  }

  function render(){ if (state.view === 'fret') renderFret(); else if (state.view === 'game') renderGame(); else if (state.view === 'lessons' && state.isPro) renderLessons(); else if (state.view === 'lessons' && !state.isPro) renderUpgradeScreen(); }
  function renderFret(){
    const { root, mode, kind, chordType, strings } = state.musical;
    const { isLeftHanded } = state; // Get handedness state

    // Enforce 4-string for non-Pro if higher strings were previously selected
    if (!state.isPro && (state.musical.strings === '5' || state.musical.strings === '6')) {
      state.musical.strings = '4';
    }

    // If not Pro and current mode is not a free mode, default to Ionian
    if (!state.isPro && !freeModes.includes(state.musical.mode)) {
      state.musical.mode = 'ionian';
    }

    const notes = kind==='scale' ? notesForMode(root, mode) : chordNotes(root, chordType);
    const tuning=getTuning(strings);
    const rootOptions = allRoots.map(k => { const isFree = freeRoots.includes(k); const disabled = !isFree && !state.isPro; return `<option ${k===root?'selected':''} value="${k}" ${disabled ? 'disabled' : ''}>${k} ${disabled ? '(Pro)' : ''}</option>`; }).join('');
    const chordOptions = allChordTypes.map(t => { const isFree = freeChordTypes.includes(t); const disabled = !isFree && !state.isPro; const label = t.replace(/([A-Z])/g,' $1').replace(/^./,s=>s.toUpperCase()); return `<option ${t===chordType?'selected':''} value="${t}" ${disabled ? 'disabled' : ''}>${label} ${disabled ? '(Pro)' : ''}</option>`; }).join('');
    
    // String options, now with Pro limitations
    const stringOptions = ['4','5','6'].map(x => {
      const disabled = !state.isPro && x !== '4';
      return `<option ${x===strings?'selected':''} value="${x}" ${disabled ? 'disabled' : ''}>${x}-string ${disabled ? '(Pro)' : ''}</option>`;
    }).join('');

    // Mode options, now with Pro limitations
    const modeOptions = Object.keys(modeOffset).map(m => {
      const isFree = freeModes.includes(m);
      const disabled = !isFree && !state.isPro;
      return `<option value="${m}" ${m===mode?'selected':''} ${disabled ? 'disabled' : ''}>${m[0].toUpperCase()+m.slice(1)} ${disabled ? '(Pro)' : ''}</option>`;
    }).join('');


    // Pass isLeftHanded to drawFretboard
    const svg = drawFretboard({ notes, root, tuning, mode:'display', isLeftHanded });
    const analysisHtml = kind==='scale' ? composeScaleAnalysis(root, mode) : composeChordAnalysis(root, chordType);
    const parent = kind==='scale' ? parentMajor(root, mode) : null;
    const parentRow = kind==='scale' ? renderParentScaleRow(parent, root) : '';
    app.innerHTML = `
      <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <aside class="pane p-5">
          <h2 class="text-xl font-bold text-sky-400 mb-4">Controls</h2>
          <div class="space-y-3">
            <div>
              <label class="block text-sm text-gray-200 mb-1">Strings</label>
              <select id="sel-strings" class="w-full rounded-md bg-gray-800/70 border border-white/10 p-2 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sky-400/60 focus-visible:ring-offset-1 focus-visible:ring-offset-slate-900">
                ${stringOptions}
              </select>
            </div>
            <div>
              <label class="block text-sm text-gray-200 mb-1">Root</label>
              <select id="sel-root" class="w-full rounded-md bg-gray-800/70 border border-white/10 p-2 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sky-400/60 focus-visible:ring-offset-1 focus-visible:ring-offset-slate-900">
                ${rootOptions}
              </select>
            </div>
            <div>
              <label class="block text-sm text-gray-200 mb-2">Display</label>
              <div class="flex bg-gray-900/60 p-1 rounded-md border border-white/10">
                <button id="btn-kind-scale" class="flex-1 px-3 py-2 rounded-md ${kind==='scale'?'bg-sky-600 text-white':'text-gray-200 hover:bg-white/10'} focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sky-400/60 focus-visible:ring-offset-1 focus-visible:ring-offset-slate-900">Scale</button>
                <button id="btn-kind-chord" class="flex-1 px-3 py-2 rounded-md ${kind==='chord'?'bg-sky-600 text-white':'text-gray-200 hover:bg-white/10'} focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sky-400/60 focus-visible:ring-offset-1 focus-visible:ring-offset-slate-900">Chord</button>
              </div>
            </div>
            <div id="box-mode" ${kind==='scale'?'':'style="display:none"'}>
              <label class="block text-sm text-gray-200 mb-1">Mode</label>
              <select id="sel-mode" class="w-full rounded-md bg-gray-800/70 border border-white/10 p-2 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sky-400/60 focus-visible:ring-offset-1 focus-visible:ring-offset-slate-900">
                ${modeOptions}
              </select>
            </div>
            <div id="box-chord" ${kind==='chord'?'':'style="display:none"'}>
              <label class="block text-sm text-gray-200 mb-1">Chord Type</label>
              <select id="sel-chord" class="w-full rounded-md bg-gray-800/70 border border-white/10 p-2 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sky-400/60 focus-visible:ring-offset-1 focus-visible:ring-offset-slate-900">
                ${chordOptions}
              </select>
            </div>
            <!-- Left-handed Mode Toggle -->
            <div class="flex items-center justify-between mt-4">
              <label for="toggle-left-handed" class="block text-sm text-gray-200">Left-handed mode</label>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="toggle-left-handed" class="sr-only peer" ${state.isLeftHanded ? 'checked' : ''}>
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-sky-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:border-gray-300 after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-sky-600"></div>
              </label>
            </div>
          </div>
        </aside>
        <section class="lg:col-span-2">
          <h2 class="text-2xl md:text-3xl font-extrabold text-sky-300 mb-2">Fretboard</h2>
          <div id="fret-wrap" class="pane p-4 overflow-x-auto">
            ${svg}
          </div>
          ${parentRow}
          <div class="pane p-4 mt-5">
            <h3 class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-sky-400 to-cyan-300 mb-3">Analysis</h3>
            <div id="ai-box" class="min-h-[12rem] p-3 bg-black/20 border border-white/10 rounded-md prose prose-invert max-w-none">
              ${analysisHtml}
            </div>
          </div>
        </section>
      </section>`;
      document.getElementById('sel-strings').onchange = e => { state.musical.strings=e.target.value; render(); };
      document.getElementById('sel-root').onchange = e => { state.musical.root=e.target.value; render(); };
      document.getElementById('btn-kind-scale').onclick = () => { state.musical.kind='scale'; render(); };
      document.getElementById('btn-kind-chord').onclick = () => { state.musical.kind='chord'; render(); };
      const sm = document.getElementById('sel-mode'); if (sm) sm.onchange = e => { state.musical.mode=e.target.value; render(); };
      const sc = document.getElementById('sel-chord'); if (sc) sc.onchange = e => { state.musical.chordType=e.target.value; render(); };

      const leftHandedToggle = document.getElementById('toggle-left-handed');
      if (leftHandedToggle) {
        leftHandedToggle.onchange = (e) => {
          state.isLeftHanded = e.target.checked;
          localStorage.setItem('bassTrainerLeftHanded', state.isLeftHanded);
          render(); // Re-render the fretboard with new handedness
        };
      }
    }
    function renderParentScaleRow(parentKey, modeRoot){ if (!parentKey) return ''; const scale = scalesMaj[parentKey] || []; const chips = scale.map(n=>{ const isModeRoot = enhNorm(n)===enhNorm(modeRoot); const isParentTonic = n===parentKey; return `<span class="chip ${isModeRoot?'chip-mode':''} ${isParentTonic?'chip-parent':''}">${n}</span>`; }).join(''); return `<div class="pane p-3 mt-4"><div class="flex items-center gap-2 flex-wrap"><span class="text-sm text-gray-300">Parent Major:</span><span class="font-bold">${parentKey}</span>${chips}</div></div>`; }
    function gameRulesAllow(openNote, fret){
      const d = state.game.difficulty;
      // Removed the specific fret > 7 limitation for non-Pro on 'standard' difficulty.
      // Now, 'standard' difficulty is 0-12 frets for all users.
      if (d==='easy' && fret>5) return false;
      if (d==='focus'){ if (!state.isPro) return false; const [s1,s2] = (state.game.focusPair||'E&A').split('&'); if (![s1,s2].includes(openNote)) return false; }
      return true;
    }

    // Modified drawFretboard to support left-handed mode and fret display limits
    function drawFretboard({ notes, root, tuning, mode, isLeftHanded }){
      const safeNotes = Array.isArray(notes) ? notes.filter(Boolean) : [];
      const rootNorm = enhNorm(root);
      const frets = 12, FW=60, SP=35, OPEN=40, PX=20, PY=30;
      const width = frets*FW + PX*2 + OPEN;
      const height = (tuning.length-1)*SP + PY*2 + 30;

      let s = `<svg id="fret-svg" width="${width}" height="${height}" viewBox="0 0 ${width} ${height}" class="rounded-xl border border-white/10 bg-zinc-800/50">`;

      // Fretboard rectangle background
      const frettedAreaStartX = isLeftHanded ? PX : PX + OPEN;
      s += `<rect x="${frettedAreaStartX}" y="${PY}" width="${frets*FW}" height="${(tuning.length-1)*SP}" fill="#1F2937" rx="8" ry="8"/>`;

      // Fret lines (including the thick nut line)
      for(let i=0;i<=frets;i++) {
        // Removed the fret limit for display mode here
        const fretLineX = isLeftHanded ? PX + i*FW : PX + OPEN + i*FW;
        s += `<line x1="${fretLineX}" y1="${PY}" x2="${fretLineX}" y2="${PY+(tuning.length-1)*SP}" class="fret"/>`;
      }

      // Thick nut line (Fret 0 marker) - drawn separately to override default fret line style
      const nutLineX = isLeftHanded ? PX + frets*FW : PX + OPEN;
      s += `<line x1="${nutLineX}" y1="${PY}" x2="${nutLineX}" y2="${PY+(tuning.length-1)*SP}" stroke="#4B5563" stroke-width="5"/>`;

      // Inlays
      ;[3,5,7,9,12].forEach(f=>{
        // Removed the fret limit for display mode here
        const cx_base = frettedAreaStartX + f*FW - FW/2;
        const cy_base = PY + ((tuning.length-1)*SP)/2;
        if (f===12){
          s+=`<circle cx="${cx_base}" cy="${cy_base-12}" r="4" class="inlay"/><circle cx="${cx_base}" cy="${cy_base+12}" r="4" class="inlay"/>`;
        } else {
          s+=`<circle cx="${cx_base}" cy="${cy_base}" r="5" class="inlay"/>`;
        }
      });

      // Fret numbers
      for(let i=0;i<frets;i++){
        const fretNum = i + 1; // Fret numbers from 1 to 12
        // Removed the fret limit for display mode here
        const fretNumX = isLeftHanded ? (PX + (frets - fretNum) * FW + FW/2) : (PX + OPEN + fretNum * FW - FW/2);
        s += `<text x="${fretNumX}" y="${PY+(tuning.length-1)*SP+10}" class="fret-num">${fretNum}</text>`;
      }

      // Strings and notes
      tuning.slice().reverse().forEach((open, idx) => {
        const y = PY + idx*SP;
        s += `<g><line x1="${PX}" y1="${y}" x2="${PX + frets*FW + OPEN}" y2="${y}" class="string"/>`; // String goes across entire SVG width

        for(let f=0; f<=frets; f++){
          // Removed the fret limit for display mode here
          const nIdx = idxFromOpen(open,f);
          const note = chromSharp[nIdx];
          const isIn = safeNotes.length>0 && safeNotes.some(nn => chromSharp.indexOf(enhNorm(nn))===nIdx);

          let circleX;
          if (f === 0) { // Open string note
            circleX = isLeftHanded ? (PX + frets * FW + OPEN / 2) : (PX + OPEN / 2);
          } else { // Fretted note
            circleX = isLeftHanded ? (PX + (frets - f) * FW + FW / 2) : (PX + OPEN + f * FW - FW / 2);
          }

          if (mode==='display'){
            if (isIn){
              const isRoot = chromSharp.indexOf(rootNorm)===nIdx;
              const cls = `n ${isRoot?'n-root':'n-scale'}`;
              s += `<g>${isRoot?`<circle cx="${circleX}" cy="${y}" r="16" class="n-root-ring"/>`:''}<circle cx="${circleX}" cy="${y}" r="12" class="${cls}"/><text x="${circleX}" y="${y}" class="nt nt-on" dominant-baseline="central" text-anchor="middle">${note}</text></g>`;
            } else if (f===0){ // Display open string label if not a scale note
              s += `<g><circle cx="${circleX}" cy="${y}" r="12" class="n n-open"/><text x="${circleX}" y="${y}" class="nt nt-off" dominant-baseline="central" text-anchor="middle">${open}</text></g>`;
            }
          } else if (mode==='game'){
            // For game mode, the 'standard' difficulty is now 0-12 frets for all users.
            // 'easy' is still 0-5. 'focus' is Pro-only.
            const actualFretLimit = (state.game.difficulty === 'easy') ? 5 : frets; // If easy, limit to 5, otherwise full frets (12)
            if (f > actualFretLimit) continue; // Skip notes beyond the allowed limit

            if (!gameRulesAllow(open, f)) continue; // Skip notes not allowed by general game rules

            const id = `${idx}-${f}`;
            const found = state.game.found.includes(id);
            const cls = `n ${found?'n-ok':'n-hide'}`;
            s += `<g class="gn" data-note="${note}" data-id="${id}"><circle cx="${circleX}" cy="${y}" r="12" class="${cls}"/><text x="${circleX}" y="${y}" class="nt nt-on" dominant-baseline="central" text-anchor="middle">${found?note:''}</text></g>`;
          }
        }
        s += `</g>`;
      });
      s += `</svg>`;
      return s;
    }
    const MODE_INFO = { ionian: { degree:1, formula:['1','2','3','4','5','6','7'], chars:[], vibe:'bright, stable', chord:'Imaj7' }, dorian: { degree:2, formula:['1','2','b3','4','5','6','b7'], chars:['6'], vibe:'minor with natural 6', chord:'iim7' }, phrygian:{ degree:3, formula:['1','b2','b3','4','5','b6','b7'], chars:['b2'], vibe:'dark, Spanish', chord:'iiim7' }, lydian:  { degree:4, formula:['1','2','3','#4','5','6','7'], chars:['#4'], vibe:'dreamy, floating', chord:'IVmaj7(#11)' }, mixolydian:{ degree:5, formula:['1','2','3','4','5','6','b7'], chars:['b7'], vibe:'dominant, bluesy', chord:'V7' }, aeolian: { degree:6, formula:['1','2','b3','4','5','b6','b7'], chars:['b6'], vibe:'natural minor', chord:'vim7' }, locrian: { degree:7, formula:['1','b2','b3','4','b5','b6','b7'], chars:['b5'], vibe:'unstable, tense', chord:'viiÃ¸7' } };
    function composeScaleAnalysis(root, mode){ const info = MODE_INFO[mode]; if (!info) return ''; const parent = parentMajor(root, mode); const parentScale = scalesMaj[parent] || []; const modeNotes = notesForMode(root, mode); const formula = info.formula.join(' '); const sections = [ `<h4 class="font-bold text-sky-300">Parent Key</h4><p><strong>${parent} major</strong> Â· ${parentScale.join(' ')}</p>`, `<h4 class="font-bold text-sky-300">Mode Notes</h4><p><strong>${root} ${mode}</strong> Â· ${modeNotes.join(' ')}</p>`, `<h4 class="font-bold text-sky-300">Formula</h4><p>${formula}</p>`, `<h4 class="font-bold text-sky-300">On the Bass</h4><ul class="list-disc ml-6"><li>Octave: up two strings, back three frets.</li><li>Lock time by landing on <strong>root</strong> and <strong>5th</strong>; color with the characteristic tone (${info.chars.join(', ')||'â'}).</li></ul>`, `<h4 class="font-bold text-sky-300">Context</h4><p>Typical chord: <strong>${info.chord}</strong>. Vibe: ${info.vibe}. Great for funk, pop, and film cues depending on tempo and note choice.</p>` ]; return sections.join(''); }
    const CHORD_INFO = { majorTriad: { name: 'Major Triad', degrees:['1','3','5'], function:'Tonic or Subdominant', character:'stable, open', usage:'I or IV in major; I in modal contexts.', resolution:'Moves anywhere; to V for lift, to vi for deceptive.', scales:['Ionian','Major pentatonic'], tips:'Outline Râ5âR; add 6 or 9 for color.' }, major7th: { name: 'Major 7th', degrees:['1','3','5','7'], function:'Tonic (Imaj7) or IVmaj7 (jazz color)', character:'lush, settled', usage:'Imaj7 holds; IVmaj7 often leads to V.', resolution:'When IVmaj7 â V or iiâV.', scales:['Ionian (over Imaj7)','Lydian (over IVmaj7)'], tips:'Target 3rd & 7th; avoid natural 4 over I unless Lydian.' }, minorTriad: { name: 'Minor Triad', degrees:['1','b3','5'], function:'Predominant or Tonic (minor)', character:'moody, neutral', usage:'ii or vi in major; i, iv, v in minor.', resolution:'Commonly â V or i.', scales:['Aeolian','Dorian','Minor pentatonic'], tips:'Use Râb3â5; add b7 for soulful motion.' }, minor7th: { name: 'Minor 7th', degrees:['1','b3','5','b7'], function:'Predominant (ii7) or Tonic (i7 modal)', character:'warm, soulful', usage:'ii7 â V7 â I; i7 holds in modal tunes.', resolution:'Guide tones (b3 & b7) pull to V7âs 3rd & root.', scales:['Dorian (over ii7)','Aeolian (over i7)'], tips:'Land b3/b7 on strong beats.' }, dominant7th: { name: 'Dominant 7th', degrees:['1','3','5','b7'], function:'Dominant', character:'tense, bluesy; wants to resolve', usage:'V7 resolving down a fifth / up a fourth to I.', resolution:'3rd of V7 â root of I; b7 of V7 â 3rd of I.', scales:['Mixolydian','Blues','Altered (on V in minor)'], tips:'Walk Râ3âb7â3; approach root chromatically into I.' }, diminishedTriad: { name: 'Diminished Triad', degrees:['1','b3','b5'], function:'Leading-tone or passing', character:'unstable, tight', usage:'viiÂ° in major; iiÂ° in minor; passing between chords.', resolution:'Resolve inward to I or outward to iii.', scales:['Locrian fragment'], tips:'Use as quick approachâdonât sit on it.' }, halfDiminished7th: { name: 'Half-Diminished 7th (m7â­5)', degrees:['1','b3','b5','b7'], function:'Predominant / Leading-tone (viiÃ¸7 in major)', character:'somber, suspended', usage:'iiÃ¸7 in minor progressions.', resolution:'â V or directly â i.', scales:['Locrian â®2'], tips:'Resolve the b5 inward (to 4 or to 5 in the next chord).' }, diminished7th: { name: 'Diminished 7th', degrees:['1','b3','b5','bb7'], function:'Leading-tone (fully diminished)', character:'high tension, symmetrical', usage:'viiÂ°7 in harmonic minor; common-tone diminished.', resolution:'Strong pull to i (enharmonically to four tonics).', scales:['WholeâHalf Diminished'], tips:'Chromatic approach into tonic; pivot enharmonically.' }, augmentedTriad: { name: 'Augmented Triad', degrees:['1','3','#5'], function:'Color dominant / mediant', character:'bright, ambiguous', usage:'V+ or III+ sonorities; filmic color.', resolution:'#5 â 6 to resolve to I or â vi.', scales:['Whole Tone'], tips:'Lean on #5 then step to 6 to âsolveâ the color.' } };
    function composeChordAnalysis(root, chordType){ const info = CHORD_INFO[chordType] || null; const tones = chordNotes(root, chordType); const niceName = chordType.replace(/([A-Z])/g,' $1').replace(/^./, s=>s.toUpperCase()); const guide = []; if (tones[1]) guide.push(tones[1]); if (tones[3]) guide.push(tones[3]); const chips = tones.map((n,i)=>`<span class="chip ${i===0?'chip-parent':''}">${n}${i===1?' (3rd)':''}${i===3?' (7th)':''}</span>`).join(''); const fnChar = info ? `<strong>${info.function}</strong> â ${info.character}.` : 'â'; const uses = info?.usage || ''; const reso = info?.resolution || ''; const tips = info?.tips || ''; const scales = info?.scales ? info.scales.join(', ') : ''; return ` <h4 class="font-bold text-sky-300">Chord</h4> <p><strong>${root} ${niceName}</strong> Â· ${tones.join(' ')}</p> <div class="mt-2">${chips}</div> <h4 class="font-bold text-sky-300 mt-3">Function & Character</h4> <p>${fnChar}</p> ${uses||reso?`<h4 class=\"font-bold text-sky-300 mt-3\">Common Uses & Resolution</h4><p>${[uses,reso].filter(Boolean).join(' â ')}</p>`:''} ${tips?`<h4 class=\"font-bold text-sky-300 mt-3\">Bass Moves</h4><ul class=\"list-disc ml-6\"><li>${tips}</li><li>Target <strong>${guide.join(' & ')||'guide tones'}</strong> on strong beats.</li></ul>`:''} ${scales?`<h4 class=\"font-bold text-sky-300 mt-3\">Suggested Scales</h4><p>${scales}</p>`:''} `; }
    const lessons = [ { title:'Understanding the Fretboard', concepts:["Only 12 unique notes exist.","Each note appears once per string < 12th fret.","Above 12th repeats."], activity:["Pick one note (e.g., C).","Find it on each string < 12th fret.","Say the note as you play.","Write the fret numbers on a diagram."], homework:["Repeat with another note.","Use the Circle of Fifths below for order."] }, { title:'Grouping the Notes', concepts:["Use the Circle of Fifths.","Break into 4 groups of 3.","Groups: CâFâBb | EbâAbâDb | GbâBâE | AâDâG"], activity:["Focus on Group 1 only.","Find each note on every string.","No metronome yet."], homework:["Practice Group 1 for 2â3 days before Group 2."] }, { title:'Adding the Metronome', concepts:["Timing reinforces accuracy.","Start slow."], activity:["40 BPM.","Pick your 3-note group.","8 reps per string per note.","Cycle all three notes."], homework:["Twice daily.","Stay at 40 BPM until clean."] }, { title:'Full Circle of Fifths Run', concepts:["Connect all notes in sequence.","Build mental maps."], activity:["Start at C.","8 reps per string.","Go through all 12 notes."], homework:["Run the full circle daily.","Accuracy before speed."] }, { title:'Two-Note Alternation', concepts:["Switch targets quickly.","Train up/down movement."], activity:["Pairs: CâF, BbâEb, AbâDb, GbâB, EâA, DâG.","Up the first, down the second."], homework:["All six pairs at 40 BPM.","No hesitation."] }, { title:'Apply to Full Circle', concepts:["Combine alternation + full circle."], activity:["Use up-one/down-next through the circle."], homework:["Daily run.","Keep 40 BPM until automatic."] }, { title:'Increase Speed', concepts:["Gradual tempo growth.","Keep accuracy."], activity:["From 40â50 BPM.","Add 5â10 weekly until 80."], homework:["Maintain top clean speed.","Revisit slow tempos weekly."] }, { title:'Make It Musical', concepts:["Groove & articulation.","Technique + knowledge."], activity:["Add drums or backing.","Fingerstyle / Slap / Pick.","Staccato, legato, accents."], homework:["Record full circle musically.","Review time, tone, accuracy."] } ];
    function renderLessons(){ const L = lessons[state.lessonIndex]; const html = ` <section class="space-y-4"> <div class="text-center"> <p class="text-sky-300 font-semibold">Lesson ${state.lessonIndex+1} of ${lessons.length}</p> <h2 class="text-2xl md:text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-sky-300 to-cyan-400">${L.title}</h2> </div> <div class="flex justify-between gap-3"> <button id="btn-prev" class="pane px-4 py-2 rounded-md text-sm ${state.lessonIndex===0?'opacity-40 cursor-not-allowed':''} focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sky-400/60 focus-visible:ring-offset-1 focus-visible:ring-offset-slate-900">Previous</button> <button id="btn-next" class="pane px-4 py-2 rounded-md text-sm ${state.lessonIndex===lessons.length-1?'opacity-40 cursor-not-allowed':''} focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sky-400/60 focus-visible:ring-offset-1 focus-visible:ring-offset-slate-900">Next</button> </div> <div class="pane p-5"> <h3 class="font-bold text-sky-400 mb-1">ð¡ Concepts</h3> <ul class="list-disc ml-6 mb-4">${L.concepts.map(x=>`<li>${x}</li>`).join('')}</ul> <h3 class="font-bold text-sky-400 mb-1">ð¸ Activity</h3> <ul class="list-disc ml-6 mb-4">${L.activity.map(x=>`<li>${x}</li>`).join('')}</ul> <h3 class="font-bold text-sky-400 mb-1">ð Homework</h3> <ul class="list-disc ml-6">${L.homework.map(x=>`<li>${x}</li>`).join('')}</ul> </div> ${renderCircle()} </section>`; app.innerHTML = html; document.getElementById('btn-prev').onclick = () => { if (state.lessonIndex>0){ state.lessonIndex--; render(); } }; document.getElementById('btn-next').onclick = () => { if (state.lessonIndex<lessons.length-1){ state.lessonIndex++; render(); } }; }
    function renderUpgradeScreen() {
      app.innerHTML = `
        <section class="pane p-8 text-center max-w-2xl mx-auto">
          <h2 class="text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-sky-400 mb-4">Upgrade to Pro</h2>
          <p class="text-lg text-gray-300 mb-6">Unlock all 8 step-by-step lessons and the complete Circle of Fifths guide to master the fretboard.</p>
          <div class="bg-gray-900/50 p-6 rounded-lg border border-white/10 mb-6">
            <p class="text-5xl font-bold text-white mb-2">$19.99</p>
            <p class="text-gray-400">One-time payment, lifetime access.</p>
          </div>
          <button id="btn-purchase" class="w-full px-6 py-3 rounded-md font-bold bg-purple-600 text-white hover:bg-purple-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-purple-400/60 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-900 text-lg">
            Unlock All Lessons
          </button>
        </section>
      `;
      const purchaseBtn = document.getElementById('btn-purchase');
      if (purchaseBtn) { // Ensure button exists before attaching event
        purchaseBtn.onclick = async () => {
          const originalText = purchaseBtn.innerHTML;
          purchaseBtn.innerHTML = '<span class="spinner"></span>Redirecting to checkout...';
          purchaseBtn.disabled = true;

          try {
            const response = await fetch(getBackendUrl('/checkout'), {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-User-Id': currentUserId // Send user ID to backend
              },
              body: JSON.stringify({ userId: currentUserId }) // Send userId in body as well for checkout
            });
            const data = await response.json();

            if (response.ok && data.url) {
              window.location.href = data.url;
            } else {
              console.error('Backend Error or Missing URL:', data.error || 'No URL provided');
              purchaseBtn.textContent = `Error: ${data.error || 'Failed to get checkout URL.'}`;
              // Re-enable button after a short delay for user to read error
              setTimeout(() => {
                purchaseBtn.innerHTML = originalText;
                purchaseBtn.disabled = false;
              }, 2000);
            }
          } catch (e) {
            console.error('Fetch Error:', e);
            purchaseBtn.textContent = 'Network Error! Please try again.';
            setTimeout(() => {
              purchaseBtn.innerHTML = originalText;
              purchaseBtn.disabled = false;
            }, 2000);
          }
        };
      }
    }
    function renderCircle(){ const entries=['C','G','D','A','E','B / Cb','F# / Gb','C# / Db','Ab','Eb','Bb','F']; const size=420; const r=180; const cx=size/2; const cy=size/2; let s = `<div class="mt-6 flex flex-col items-center"> <h3 class='text-lg font-semibold text-sky-400 mb-2'>Reference: Circle of Fifths</h3> <svg width='${size}' height='${size}' viewBox='0 0 ${size} ${size}'>`; s += `<circle cx='${cx}' cy='${cy}' r='${r}' fill='rgba(17,24,39,.55)' stroke='rgba(255,255,255,.12)' stroke-width='2'/>`; s += `<circle cx='${cx}' cy='${cy}' r='${r-22}' fill='none' stroke='rgba(255,255,255,.08)' stroke-dasharray='6 10'/>`; for(let i=0;i<12;i++){ const a=(i*30-90)*Math.PI/180; const x1=cx+(r-12)*Math.cos(a), y1=cy+(r-12)*Math.sin(a); const x2=cx+(r-2)*Math.cos(a), y2=cy+(r-2)*Math.sin(a); s += `<line x1='${x1}' y1='${y1}' x2='${x2}' y2='${y2}' stroke='rgba(255,255,255,.22)' stroke-width='1'/>`; } entries.forEach((entry,i)=>{ const a=(i*30-90)*Math.PI/180; const tx=cx+(r-36)*Math.cos(a), ty=cy+(r-36)*Math.sin(a); const parts = entry.split(' / '); if (parts.length===1){ s += `<text x='${tx}' y='${ty}' text-anchor='middle' dominant-baseline='central' fill='#e5e7eb' font-weight='700' font-size='18'>${parts[0]}</text>`; } else { s += `<text x='${tx}' y='${ty-8}' text-anchor='middle' fill='#e5e7eb' font-weight='700' font-size='14'>${parts[0]}</text>`; s += `<text x='${tx}' y='${ty+12}' text-anchor='middle' fill='#cbd5e0' font-weight='700' font-size='14'>${parts[1]}</text>`; } const dx=cx+(r-6)*Math.cos(a), dy=cy+(r-6)*Math.sin(a); s += `<circle cx='${dx}' cy='${dy}' r='2' fill='rgba(103,232,249,.6)'/>`; }); s += `</svg></div>`;  return s; }
    function gameRulesAllow(openNote, fret){
      const d = state.game.difficulty;
      // Removed the specific fret > 7 limitation for non-Pro on 'standard' difficulty.
      // Now, 'standard' difficulty is 0-12 frets for all users.
      if (d==='easy' && fret>5) return false;
      if (d==='focus'){ if (!state.isPro) return false; const [s1,s2] = (state.game.focusPair||'E&A').split('&'); if (![s1,s2].includes(openNote)) return false; }
      return true;
    }
    function computeTotalForTarget(target){
      const tuning=getTuning(state.musical.strings);
      let total=0;
      tuning.forEach(open=>{
        for(let f=0; f<=12; f++){
          // Use the gameRulesAllow to compute total playable notes for scoring
          if (!gameRulesAllow(open,f)) continue;
          if (chromSharp[idxFromOpen(open,f)]===target) total++;
        }
      });
      return total;
    }
    function startGame(){
      const notes = chromSharp;
      const target = notes[Math.floor(Math.random()*notes.length)];
      const total = computeTotalForTarget(target);
      Object.assign(state.game,{
        on:true, over:false, target, found:[], total, t0:Date.now(), t1:null,
        combo:0, misses:0, msg:'', lastHintAt:null, difficulty:'standard', focusPair:'E&A', justFound:0,
        hintsUsed: 0,
        score: 0 // Reset score for new game
      });
      if (state.game.timer) clearInterval(state.game.timer);
      render();
    }
    function restartRound(){
      if (!state.game.target){ startGame(); return; }
      const t = state.game.target;
      const total = computeTotalForTarget(t);
      Object.assign(state.game,{
        on:true, over:false, target:t, found:[], total, t0:Date.now(), t1:null,
        combo:0, misses:0, msg:'', lastHintAt:null, justFound:0,
        hintsUsed: 0,
        score: 0 // Reset score for new round
      });
      if (state.game.timer) clearInterval(state.game.timer);
      render();
    }
    function hintOne(){
      const now = Date.now();
      // Check if hints are available for non-pro users (1 per game)
      if (!state.isPro && state.game.hintsUsed >= 1) {
        return;
      }
      // Original cooldown logic
      if (state.game.lastHintAt && (now - state.game.lastHintAt) < 10000) return;

      const nodes = Array.from(document.querySelectorAll(`.gn[data-note="${state.game.target}"]`));
      const hidden = nodes.filter(n => !state.game.found.includes(n.getAttribute('data-id')));
      if (!hidden.length) return;
      const pick = hidden[Math.floor(Math.random()*hidden.length)];
      const circle = pick.querySelector('circle');
      if (circle){
        circle.classList.add('n-hint');
        setTimeout(()=>circle.classList.remove('n-hint'), 1100);
      }
      state.game.lastHintAt = now;
      if (!state.isPro) { // Only decrement for non-pro users
        state.game.hintsUsed++;
      }
      render(); // Re-render to update hint button state
    }
    function onGameClick(e){
      const g = e.target.closest('.gn');
      if (!g) return;
      const note = g.getAttribute('data-note');
      const id = g.getAttribute('data-id');
      const c = g.querySelector('circle');

      // Prevent interaction with already found notes or notes outside current game rules
      if (state.game.found.includes(id) || !gameRulesAllow(tuning.slice().reverse()[parseInt(id.split('-')[0])], parseInt(id.split('-')[1]))) return;

      if (note===state.game.target){
        state.game.found.push(id);
        state.game.combo++;
        state.game.score += 100 + (state.game.combo * 10); // Reward for correct note and combo
        state.game.justFound = state.game.found.length;
        if (c){
          c.classList.add('hit-pulse');
          c.classList.remove('n-hide');
          c.classList.add('n-ok');
          setTimeout(()=>c.classList.remove('hit-pulse'),180);
        }
        if (state.game.found.length===state.game.total){
          endGame();
          return;
        }
      } else {
        state.game.combo=0;
        state.game.misses++;
        state.game.score = Math.max(0, state.game.score - 50); // Penalize for incorrect note
        if (c){
          c.classList.add('miss-shake');
          c.classList.remove('n-hide');
          c.classList.add('n-bad');
          setTimeout(()=>{
            if (!state.game.found.includes(id)){
              c.classList.remove('n-bad');
              c.classList.add('n-hide');
            }
            c.classList.remove('miss-shake');
          },220);
        }
      }
      setTimeout(render, 180);
    }
    function endGame(){
      state.game.on=false;
      state.game.over=true;
      state.game.t1=Date.now();

      // Calculate final score with time bonus
      const timeTakenSeconds = (state.game.t1 - state.game.t0) / 1000;
      const timeBonus = Math.max(0, 1000 - (timeTakenSeconds * 10)); // Example: 1000 points, -10 for each second
      state.game.score = Math.max(0, state.game.score + timeBonus); // Ensure score doesn't go negative

      // Update high score
      if (state.game.score > state.game.highScore) {
        state.game.highScore = state.game.score;
        localStorage.setItem('bassTrainerHighScore', state.game.highScore);
      }

      burstConfetti();
      render();
    }
    function progressBarHtml(total, found){ let html=''; for(let i=0;i<total;i++){ html += `<span class="bar ${i<found?'fg':'bg'} w-5" data-idx="${i}"></span>`; } return html; }
    function burstConfetti(){ const colors=['#22D3EE','#A78BFA','#34D399','#F59E0B','#F472B6']; for(let i=0;i<28;i++){ const el=document.createElement('span'); el.className='confetti-piece'; el.style.left = Math.random()*100 + 'vw'; el.style.background = colors[Math.floor(Math.random()*colors.length)]; el.style.animationDuration = (1 + Math.random()*0.8)+'s'; el.style.transform = `translateY(-20px) rotate(${Math.random()*360}deg)`; document.body.appendChild(el); setTimeout(()=>el.remove(), 1800);} }


    // ---- NAV ----
    function bindNav(){
      document.getElementById('nav-fret').onclick = () => { state.view='fret'; setActive('fret'); render(); };
      document.getElementById('nav-lessons').onclick = () => { state.view='lessons'; setActive('lessons'); render(); };
      document.getElementById('nav-game').onclick = () => { state.view='game'; setActive('game'); render(); };
    }

    function setActive(which){ ['fret','lessons','game'].forEach(id=>{ const btn=document.getElementById('nav-'+id); if (!btn) return; if (id===which){ btn.classList.add('bg-sky-600','text-white'); btn.classList.remove('hover:bg-white/10','text-gray-200'); } else { btn.classList.remove('bg-sky-600','text-white'); btn.classList.add('hover:bg-white/10','text-gray-200'); } }); }

    // --- NEW FUNCTION TO UPDATE NAV UI ---
    function updateNav() {
      const lessonsBtn = document.getElementById('nav-lessons');
      if (!lessonsBtn) return;

      if (state.isPro) {
        lessonsBtn.textContent = 'Lessons';
      } else {
        lessonsBtn.textContent = 'Unlock Lessons';
      }
    }

    // --- MODIFIED & SECURE INIT ---
    async function checkPurchase() {
      const urlParams = new URLSearchParams(window.location.search);
      const sessionId = urlParams.get('session_id');

      if (sessionId) {
        // We have a session ID, now we must verify it with the backend.
        try {
          const response = await fetch(getBackendUrl('/verify-purchase'), {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-User-Id': currentUserId // Send user ID to backend
            },
            body: JSON.stringify({ sessionId: sessionId })
          });

          const data = await response.json();

          if (response.ok && data.success) {
            // Backend confirmed payment! Now we grant access.
            console.log('Purchase verified successfully!');
            state.isPro = true;
            // No localStorage.setItem('bassTrainerPro', 'true'); here, rely on backend for persistence
            // and the next /user-status call to confirm.

            // Since the status is now confirmed, we can switch the view to the lessons page.
            state.view = 'lessons';

          } else {
              // Backend said the session was invalid or not paid
              console.error('Purchase verification failed:', data.error);
              // Optionally, show a message to the user that verification failed
          }

        } catch (error) {
          console.error('Error verifying purchase:', error);
          // Optionally, show a network error message
        } finally {
          // Clean the URL to remove the session_id parameter, regardless of outcome.
          window.history.replaceState({}, document.title, window.location.pathname);
          // After verification, re-fetch status from backend to ensure UI is consistent
          await fetchProStatusFromBackend(); 
        }
      }
    }

    // --- Final Initialization Sequence ---
    // This will now wait for Pro status to load from the backend
    bindNav();
    state.isProStatusLoaded = false; // Set loading flag
    await checkPurchase(); // Check for pending Stripe purchases first
    if (!state.isProStatusLoaded) { // Only fetch if not already loaded by checkPurchase
      await fetchProStatusFromBackend(); // Then fetch current user status
    }
  });
</script>
</body>
</html>
